const { GoogleGenerativeAI } = require("@google/generative-ai");

// פונקציה יצירת דו''ח בינה מלאכותית של ג'מיני
async function buildReport(userProfile) {
  // הכנת טקסט חוקים להצגה בדו''ח כולל FALLBACK במיקרה ובו אין התאמות
  const profileText =
    !userProfile || Object.keys(userProfile).length === 0
      ? "אין נתוני פרופיל — יש להזין נתונים בסיסיים כמו גיל, מין, משקל ופעילות."
      : userProfile;

  try {
    const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY); // יצירת מופע חדש של המחלקה GoogleGenerativeAI תוך שימוש במפתח ה-API שנשמר במשתנה הסביבה

    // בחירת מודל לשליחת הפרופיל והפרומפט
    const model = genAI.getGenerativeModel({
      model: "gemini-2.0-flash",
    });

    // הנחיית המכונה
    const prompt = `
אתה מאמן כושר ותזונאי וירטואלי חכם.

להלן פרופיל משתמש בפורמט JSON:
${JSON.stringify(profileText, null, 2)}

המטרה שלך:
בהתאם לפרמטרים שבפרופיל (כמו גיל, מין, גובה, משקל, מטרה, רמת פעילות, העדפות מזון, העדפות תזונתיות כמו כשרות או צמחונות, ונתוני BMR ו-TDEE) — צור דו"ח תזונה יומי מותאם אישית.

הדו"ח צריך לכלול את הסעיפים הבאים בלבד:

1. **תפריט יומי אישי (סדר ארוחות ותזונה)**  
   - סדר ארוחות מומלץ ליום שלם (לפחות 5 ארוחות: בוקר, ביניים, צהריים, ערב, ולילה).  
   - ציין את סוגי המזונות בכל ארוחה בהתאם למטרה (למשל: מסה, חיטוב או בריאות כללית).  
   - פרט את כמות הקלוריות המשוערת לכל ארוחה, בהתבסס על ה־TDEE.  
   - התאם את התפריט להרגלי המשתמש (למשל אם הוא שומר כשרות, צמחוני, או אלרגי למרכיבים מסוימים).  
   - אם הוזכרו מאכלים אהובים, כלול אותם כחלק מהתפריט.

2. **סיכום תזונתי כללי**  
   - סך כל הקלוריות היומיות.  
   - הערכת יחסי מאקרונוטריינטים (חלבונים / פחמימות / שומנים).  
   - הסבר קצר איך התפריט הזה תומך במטרה של המשתמש (מסה, חיטוב, בריאות כללית וכו’).  

חשוב:
- כתוב בעברית ברורה וזורמת.  
- השתמש בטון מקצועי אך נגיש.  
- החזר את התוצאה בפורמט Markdown כך שיהיה ניתן להציג אותה ישירות למשתמש, לדוגמה:

### דו"ח תזונה מותאם אישית
**קלוריות יומיות:** [מספר] קק"ל  
**מטרה:** [מטרת המשתמש]

#### 🥗 תפריט יומי
- **ארוחת בוקר:** ...
- **ארוחת ביניים:** ...
- **ארוחת צהריים:** ...
- **ארוחת ערב:** ...
- **ארוחת לילה:** ...

#### ⚖️ סיכום תזונתי
- סך קלוריות: ...  
- חלבון: ... גרם  
- פחמימות: ... גרם  
- שומן: ... גרם  

#### 💬 הערות כלליות
[פסקה קצרה שמסבירה איך התפריט מתאים למטרה של המשתמש ולפרמטרים האישיים שלו]
`;

    const result = await model.generateContent(prompt); // שליחת הפרומפט למודל הבינה המלאכותית והמתנה לתשובת התוכן שנוצר
    return result.response.text(); // // החזרת הטקסט שנוצר מתוך אובייקט התגובה של המודל
  } catch (err) {
    console.error("Error generaiting AI report:", err.message);
    return `
     לא ניתן היה ליצור דו"ח אוטומטי כרגע.
      נתוני העסק התקבלו בהצלחה, והחוקים שזוהו הם:
      ${profileText}
    `;
  }
}

module.exports = { buildReport };
